# Release workflow for DOMAgent
#
# Trigger: push of a version tag matching v*.*.* (e.g. v0.1.0)
#
# This workflow:
#   1. Validates the tag format and package.json version match
#   2. Creates a GitHub release (draft) — the SLSA workflow fires on
#      the "release created" event and attaches provenance automatically
#
# NOTE: The actual artifact building and provenance signing is handled
# by .github/workflows/generator-generic-ossf-slsa3-publish.yml
# which triggers on the release creation event emitted by this workflow.

name: Release

on:
  push:
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]+'

permissions:
  contents: write  # Needed to create the GitHub release

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      # ── Validate tag matches package.json version ─────────────────
      - name: Validate version consistency
        run: |
          TAG_VERSION="${GITHUB_REF_NAME#v}"
          PKG_VERSION=$(node -p "require('./domagent-mcp/package.json').version")
          echo "Git tag version:     ${TAG_VERSION}"
          echo "package.json version: ${PKG_VERSION}"
          if [ "${TAG_VERSION}" != "${PKG_VERSION}" ]; then
            echo "ERROR: Git tag v${TAG_VERSION} does not match package.json version ${PKG_VERSION}"
            echo "Update domagent-mcp/package.json before tagging a release."
            exit 1
          fi

      # ── Create the GitHub release (triggers SLSA workflow) ────────
      # Creating the release here with "draft: false" emits the
      # "release: created" event that fires the SLSA generator.
      - name: Create GitHub release
        uses: softprops/action-gh-release@v2
        with:
          name: "DOMAgent ${{ github.ref_name }}"
          draft: false
          prerelease: ${{ contains(github.ref_name, '-') }}
          generate_release_notes: true
          body: |
            ## DOMAgent ${{ github.ref_name }}

            ### Artifacts
            The following artifacts are attached to this release and have
            SLSA Level 3 provenance (see `multiple.intoto.jsonl`):

            | File | Description |
            |------|-------------|
            | `domagent-chrome-*.zip` | Chrome extension — load via chrome://extensions |
            | `domagent-firefox-*.xpi` | Firefox extension — load via about:debugging |
            | `domagent-mcp-*.tgz` | MCP server Node.js package |

            ### Installation
            See [README.md](https://github.com/${{ github.repository }}/blob/main/README.md)
            for full setup instructions.

            ### Verify provenance
            ```bash
            # Install the SLSA verifier
            go install github.com/slsa-framework/slsa-verifier/v2/cli/slsa-verifier@latest

            # Verify an artifact
            slsa-verifier verify-artifact domagent-chrome-*.zip \
              --provenance-path multiple.intoto.jsonl \
              --source-uri github.com/${{ github.repository }}
            ```
