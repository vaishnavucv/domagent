# Auto Release — fires on every push to main
#
# What this does:
#   1. Reads the current version from domagent-mcp/package.json
#   2. Bumps the patch number  (e.g. 1.0.0 -> 1.0.1)
#   3. Commits the version bump back to main with "[skip ci]"
#      so this workflow does NOT re-trigger on its own commit
#   4. Packages all three release artifacts directly:
#        - domagent-chrome-<version>.zip   (Chrome extension)
#        - domagent-firefox-<version>.xpi  (Firefox extension)
#        - domagent-mcp-<version>.tgz      (MCP server npm pack)
#   5. Creates a git tag  (e.g. v1.0.1)
#   6. Creates a GitHub Release and uploads all three artifacts
#   7. Outputs SHA-256 digests so the SLSA provenance job can sign them
#
# Skip condition:
#   Commits whose message contains "[skip ci]" are ignored.
#   The version-bump commit made by this workflow always contains
#   "[skip ci]" so the loop is broken.
#
# ─────────────────────────────────────────────────────────────────────
# DEV TEAM NOTE — Full release pipeline flow
# ─────────────────────────────────────────────────────────────────────
#
#   push to main
#       │
#       ▼
#   auto-release.yml  (sequential steps, single job)
#     1. bump package.json patch version
#     2. commit "[skip ci]" → push to main
#     3. pack Chrome ZIP
#     4. pack Firefox XPI
#     5. npm pack → domagent-mcp-X.Y.Z.tgz
#     6. git tag vX.Y.Z
#     7. Create GitHub Release + upload all 3 files
#       │
#       │  "release: created" fires TWO workflows IN PARALLEL
#       ├──────────────────────────────────────────────────────────┐
#       ▼                                                          ▼
#   generator-generic-ossf-slsa3-publish.yml          npm-publish.yml
#     - SHA-256 all 3 artifacts                          - checkout the release tag
#     - SLSA signs provenance                            - verify version matches tag
#     - uploads multiple.intoto.jsonl                    - npm publish domagent
#         to the release                                     using NPM_TOKEN secret
#
# ─────────────────────────────────────────────────────────────────────

name: Auto Release on push to main

on:
  push:
    branches:
      - main

jobs:
  # ──────────────────────────────────────────────────────────────────
  # Job 1: Bump version, build artifacts, create release
  # ──────────────────────────────────────────────────────────────────
  build-and-release:
    name: Build artifacts and create release
    runs-on: ubuntu-latest

    # Do not run on version-bump commits made by this workflow itself
    if: "!contains(github.event.head_commit.message, '[skip ci]')"

    permissions:
      contents: write  # push version bump commit + tag + create release

    outputs:
      version: ${{ steps.version.outputs.new }}
      digests: ${{ steps.hash.outputs.digests }}

    steps:
      # ── 1. Checkout ───────────────────────────────────────────────
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      # ── 2. Node.js ────────────────────────────────────────────────
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # ── 3. Bump patch version in package.json ─────────────────────
      #   --no-git-tag-version: only writes to package.json, no git ops
      - name: Bump patch version
        id: version
        run: |
          cd domagent-mcp

          OLD=$(node -p "require('./package.json').version")
          RAW=$(npm version patch --no-git-tag-version)
          NEW="${RAW#v}"

          echo "old=${OLD}" >> "${GITHUB_OUTPUT}"
          echo "new=${NEW}" >> "${GITHUB_OUTPUT}"
          echo "Version bumped: ${OLD} -> ${NEW}"

      # ── 4. Commit version bump back to main ───────────────────────
      #   "[skip ci]" prevents this commit from re-triggering the workflow
      - name: Commit version bump
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add domagent-mcp/package.json
          git commit -m "bump version to ${{ steps.version.outputs.new }} [skip ci]"
          git push origin main

      # ── 5. Package Chrome extension as ZIP ───────────────────────
      - name: Package Chrome extension
        run: |
          cd domagent-extension
          zip -r "../domagent-chrome-${{ steps.version.outputs.new }}.zip" chrome/ \
            --exclude "chrome/.DS_Store" \
            --exclude "chrome/__MACOSX"
          echo "Packaged Chrome extension:"
          ls -lh "../domagent-chrome-${{ steps.version.outputs.new }}.zip"

      # ── 6. Package Firefox extension as XPI ──────────────────────
      - name: Package Firefox extension
        run: |
          cd domagent-extension
          zip -r "../domagent-firefox-${{ steps.version.outputs.new }}.xpi" firefox/ \
            --exclude "firefox/.DS_Store" \
            --exclude "firefox/__MACOSX"
          echo "Packaged Firefox extension:"
          ls -lh "../domagent-firefox-${{ steps.version.outputs.new }}.xpi"

      # ── 7. Package MCP server via npm pack ────────────────────────
      - name: Package MCP server
        run: |
          cd domagent-mcp
          npm ci --ignore-scripts
          npm pack
          mv domagent-*.tgz "../domagent-mcp-${{ steps.version.outputs.new }}.tgz"
          echo "Packaged MCP server:"
          ls -lh "../domagent-mcp-${{ steps.version.outputs.new }}.tgz"

      # ── 8. Compute SHA-256 digests (passed to SLSA provenance job) ─
      - name: Generate artifact digests
        id: hash
        run: |
          set -euo pipefail
          files=(
            "domagent-chrome-${{ steps.version.outputs.new }}.zip"
            "domagent-firefox-${{ steps.version.outputs.new }}.xpi"
            "domagent-mcp-${{ steps.version.outputs.new }}.tgz"
          )
          echo "Artifact sizes:"
          ls -lh "${files[@]}"
          echo "hashes=$(sha256sum "${files[@]}" | base64 -w0)" >> "${GITHUB_OUTPUT}"

      # ── 9. Create git tag ─────────────────────────────────────────
      - name: Create git tag
        run: |
          TAG="v${{ steps.version.outputs.new }}"
          git tag "${TAG}"
          git push origin "${TAG}"
          echo "Tagged: ${TAG}"

      # ── 10. Create GitHub Release and upload all artifacts ──────────
      #   Artifacts are attached HERE — no waiting on a second workflow.
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: "v${{ steps.version.outputs.new }}"
          name: "DOMAgent v${{ steps.version.outputs.new }}"
          generate_release_notes: true
          files: |
            domagent-chrome-${{ steps.version.outputs.new }}.zip
            domagent-firefox-${{ steps.version.outputs.new }}.xpi
            domagent-mcp-${{ steps.version.outputs.new }}.tgz
          body: |
            ## DOMAgent v${{ steps.version.outputs.new }}

            Released automatically from commit [`${{ github.sha }}`](${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}) on `main`.

            **Commit:** ${{ github.event.head_commit.message }}

            ---

            ### Downloads

            | File | Description |
            |------|-------------|
            | `domagent-chrome-${{ steps.version.outputs.new }}.zip` | Chrome extension — load via `chrome://extensions` |
            | `domagent-firefox-${{ steps.version.outputs.new }}.xpi` | Firefox extension — load via `about:debugging` |
            | `domagent-mcp-${{ steps.version.outputs.new }}.tgz` | MCP server Node.js package |
            | `multiple.intoto.jsonl` | SLSA Level 3 signed provenance (attached by provenance job) |

            ---

            ### MCP server — quickest install

            ```bash
            npx domagent
            ```

            Or install globally: `npm install -g domagent`

            Add to Claude Desktop or any MCP-compatible agent:

            ```json
            {
              "mcpServers": {
                "domagent": {
                  "command": "npx",
                  "args": ["domagent"]
                }
              }
            }
            ```

            ---

            ### Install the Chrome extension
            1. Download `domagent-chrome-${{ steps.version.outputs.new }}.zip`
            2. Unzip it into a folder
            3. Go to `chrome://extensions` → enable **Developer mode** → **Load unpacked** → select the unzipped folder

            ### Install the Firefox extension
            1. Download `domagent-firefox-${{ steps.version.outputs.new }}.xpi`
            2. Go to `about:debugging#/runtime/this-firefox` → **Load Temporary Add-on** → select the `.xpi` file

            ---

            ### Verify provenance (SLSA Level 3)
            ```bash
            slsa-verifier verify-artifact domagent-chrome-${{ steps.version.outputs.new }}.zip \
              --provenance-path multiple.intoto.jsonl \
              --source-uri github.com/${{ github.repository }}
            ```

  # ──────────────────────────────────────────────────────────────────
  # Job 2: Sign SLSA Level 3 provenance and attach to release
  # Runs after build-and-release completes successfully
  # ──────────────────────────────────────────────────────────────────
  provenance:
    name: Generate SLSA provenance
    needs: [build-and-release]
    permissions:
      actions: read    # read workflow path for provenance
      id-token: write  # sign provenance with GitHub OIDC token
      contents: write  # upload provenance file to the release
    uses: slsa-framework/slsa-github-generator/.github/workflows/generator_generic_slsa3.yml@v2.0.0
    with:
      base64-subjects: "${{ needs.build-and-release.outputs.digests }}"
      upload-assets: true
